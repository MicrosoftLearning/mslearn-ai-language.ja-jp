---
lab:
  title: カスタム テキスト分類
  description: Azure AI Language を使用してカスタム分類をテキスト入力に適用します。
---

# カスタム テキスト分類

Azure AI Language には、キー フレーズ特定、テキスト要約、感情分析など、いくつかの NLP 機能があります。 この Language サービスには、カスタムの質問応答やカスタム テキスト分類などのカスタム機能も用意されています。

Azure AI Language サービスのカスタム テキスト分類をテストするには、Language Studio を使用してモデルを構成し、Python アプリケーションを使用してテストします。

この演習は Python に基づいていますが、次のような複数の言語固有の SDK を使用してテキスト分類アプリケーションを開発できます。

- [Python 用 Azure AI Text Analytics クライアント ライブラリ](https://pypi.org/project/azure-ai-textanalytics/)
- [.NET 用 Azure AI Text Analytics クライアント ライブラリ](https://www.nuget.org/packages/Azure.AI.TextAnalytics)
- [JavaScript 用 Azure AI Text Analytics クライアント ライブラリ](https://www.npmjs.com/package/@azure/ai-text-analytics)

この演習の所要時間は約 **35** 分です。

## *Azure AI Language* リソースをプロビジョニングする

サブスクリプションにまだリソースがない場合は、**Azure AI Language サービス** リソースをプロビジョニングする必要があります。 さらに、カスタム テキスト分類を使用して、**カスタム テキスト分類と抽出**機能を有効にする必要があります。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
1. **[リソースの作成]** を選択します。
1. 検索フィールドで、**言語サービス**を検索します。 次に、結果で、**[言語サービス]** の下の **[作成]** を選択します。
1. **[カスタム テキスト分類]** を含むボックスを選びます。 **[リソースの作成を続行する]** を選びます。
1. 次の設定を使ってリソースを作成します。
    - **[サブスクリプション]**: *お使いの Azure サブスクリプション*。
    - **リソース グループ**: *リソース グループを選択または作成します*。
    - **リージョン**: *次のいずれかのリージョンから選択します。*\*
        - オーストラリア東部
        - インド中部
        - 米国東部
        - 米国東部 2
        - 北ヨーロッパ
        - 米国中南部
        - スイス北部
        - 英国南部
        - 西ヨーロッパ
        - 米国西部 2
        - 米国西部 3
    - **[名前]**: *一意の名前を入力します*。
    - **価格レベル**: F が利用できない場合、**F0** (*Free*) または **S** (*Standard*) を選択します。
    - **ストレージ アカウント**: 新しいストレージ アカウント
      - **ストレージ アカウント名**: "*一意の名前を入力します*"。
      - **[ストレージ アカウントの種類]**: 標準 LRS
    - **[責任ある AI に関する注意]**: オン。

1. **[確認および作成]** を選び、**[作成]** を選んでリソースをプロビジョニングします。
1. デプロイが完了するまで待ってから、リソース グループに移動します。
1. 作成したストレージ アカウントを見つけて、[アカウントの種類] が **[StorageV2]** であることを確認します。__ v1 の場合は、そのリソース ページでストレージ アカウントの種類をアップグレードします。

## ユーザーのロールベースのアクセスを構成する

> **注**:この手順をスキップすると、カスタム プロジェクトに接続しようとしたときに 403 エラーが発生します。 自分がストレージ アカウントの所有者であっても、現在のユーザーがストレージ アカウント BLOB データにアクセスするためにこのロールを持っていることが重要です。

1. Azure portal でストレージ アカウントのページに移動します。
2. 左側のナビゲーション メニューで **[アクセス制御 (IAM)]** を選択します。
3. **[追加]** を選択してロールの割り当てを追加し、ストレージ アカウントに対して **[ストレージ BLOB データ共同作成者]** ロールを選択します。
4. **[アクセスの割り当て先]** 内で、**[ユーザー、グループ、またはサービス プリンシパル]** を選択します。
5. **[メンバーの選択]** を選択します。
6. ユーザーを選択します。 **[選択]** フィールドでユーザー名を検索できます。

## サンプル記事をアップロードする

Azure AI Language サービスとストレージ アカウントを作成したら、後でモデルをトレーニングするためのサンプル記事をアップロードする必要があります。

1. 新しいブラウザー タブで、`https://aka.ms/classification-articles` からサンプル記事をダウンロードし、選択したフォルダーにファイルを抽出します。

1. Azure portal で、作成したストレージ アカウントに移動して選択します。

1. ストレージ アカウントで、**[設定]** の下にある **[構成]** を選択します。 [構成] 画面で、**[BLOB 匿名アクセスを許可する]** オプションを有効にし、**[保存]** を選択します。

1. **[データ ストレージ]** の下にある、左側のメニューの **[コンテナー]** を選択します。 表示された画面で、**[+ コンテナー]** を選択します。 コンテナーに `articles` という名前を付け、**[匿名アクセス レベル]** を **[コンテナー (コンテナーと BLOB の匿名読み取りアクセス)]** に設定します。

    > **注**: 実際のソリューション用にストレージ アカウントを構成する場合は、適切なアクセス レベルを割り当てるように注意してください。 各アクセス レベルの詳細については、「[Azure Storage に関するドキュメント](https://learn.microsoft.com/azure/storage/blobs/anonymous-read-access-configure)」をご覧ください。

1. コンテナーを作成したら、それを選び、**[アップロード]** ボタンを選びます。 **[ファイルの参照]** を選んで、ダウンロードしたサンプル記事を参照します。 **[アップロード]** を選択します。

## カスタム テキスト分類プロジェクトを作成する

構成が完了したら、カスタム テキスト分類プロジェクトを作成します。 このプロジェクトによって、モデルのビルド、トレーニング、デプロイを行うための作業場所が提供されます。

> **注**: このラボでは、**Language Studio** を使用しますが、REST API を使用してモデルの作成、ビルド、トレーニング、デプロイを行うこともできます。

1. 新しいブラウザー タブで Azure AI Language ポータル (`https://language.cognitive.azure.com/`) を開き、お使いの Azure サブスクリプションに関連付けられている Microsoft アカウントを使ってサインインします。
1. 言語リソースの選択を求めるメッセージが表示されたら、次の設定を選択します。

    - **Azure ディレクトリ**: ご利用のサブスクリプションを含む Azure ディレクトリ
    - **Azure サブスクリプション**: ご利用の Azure サブスクリプション
    - **リソースの種類**: 言語。
    - **言語リソース**: 以前に作成した Azure AI Language リソース。

    言語リソースの選択を求めるメッセージが表示<u>されない</u>場合、原因として、お使いのサブスクリプションに複数の言語リソースが存在していることが考えられます。その場合は、次の操作を行います。

    1. ページの上部にあるバーで、**[設定] (&#9881;)** ボタンを選択します。
    2. **[設定]** ページで、**[リソース]** タブを表示します。
    3. 作成したばかりの言語リソースを選択し、**[リソースの切り替え]** をクリックします。
    4. ページの上部で、**[Language Studio]** をクリックして、Language Studio のホーム ページに戻ります。

1. ポータルの上部にある **[新規作成]** メニューで、**[カスタム テキスト分類]** を選択します。
1. **[記憶域への接続]** ページが表示されます。 すべての値は既に入力されています。 そのため、**[次へ]** を選びます。
1. **[プロジェクト タイプの選択]** ページで、**[単一ラベル分類]** を選びます。 **[次へ]** を選択します。
1. **[基本情報の入力]** ペインで以下を設定します。
    - **名前**: `ClassifyLab`  
    - **テキストのプライマリ言語**: 英語 (米国)
    - **説明**: `Custom text lab`

1. [**次へ**] を選択します。
1. **[コンテナーの選択]** ページで、**[BLOB ストレージ コンテナー]** ドロップダウンをお使いの*記事*コンテナーに設定します。
1. **[No, I need to label my files as part of this project] (いいえ、このプロジェクトの一部としてファイルにラベルを付ける必要があります)** オプションを選びます。 **[次へ]** を選択します。
1. **[プロジェクトの作成]** を選択します。

> **ヒント**: "この操作を実行する権限がありません" というエラー メッセージを受信した場合は、ロールの割り当てを追加する必要があります。 このエラーを修正するために、ラボを実行しているユーザーのストレージ アカウントに "ストレージ Blob データ共同作成者" ロールを追加します。 詳細については、[こちらのドキュメント](https://learn.microsoft.com/azure/ai-services/language-service/custom-named-entity-recognition/how-to/create-project?tabs=portal%2Clanguage-studio#enable-identity-management-for-your-resource)を参照してください。

## データにラベルを付ける

プロジェクトが作成されたので、テキストの分類方法をモデルにトレーニングするためにデータにラベル (タグ) を付ける必要があります。

1. 左側にある **[データのラベル付け]** をまだ選んでいない場合は選びます。 ストレージ アカウントにアップロードしたファイルの一覧が表示されます。
1. 右側にある **[アクティビティ]** ペインで **[+ クラスの追加]** を選びます。  このラボの記事は、4 つのクラスに分類されるため、`Classifieds`、`Sports`、`News`、`Entertainment` を作成する必要があります。

    ![タグ データ ページとクラスの追加ボタンを示すスクリーンショット。](../media/tag-data-add-class-new.png#lightbox)

1. 4 つのクラスを作成したら、**[Article 1] (記事 1)** を選んで開始します。 ここでは、この記事を読み、このファイルがどのクラスであるか、そしてどのデータセット (トレーニングまたはテスト) に割り当てるかを定義できます。
1. 右側にある **[アクティビティ]** ペインを使って、各記事に適切なクラスとデータセット (トレーニングまたはテスト) を割り当てます。  右側にあるラベルの一覧からラベルを選び、[アクティビティ] ペインの下部にあるオプションを使って、各記事を**トレーニング**または**テスト**に設定できます。 **[次のドキュメント]** を選んで次のドキュメントに移動します。 このラボの目的として、モデルのトレーニングとモデルのテストのどちらに使うかを定義します。

    | [アーティクル]  | クラス  | データセット  |
    |---------|---------|---------|
    | Article 1 | スポーツ | トレーニング |
    | Article 10 | News | トレーニング |
    | Article 11 | エンターテイメント | テスト |
    | Article 12 | News | テスト |
    | Article 13 | スポーツ | テスト |
    | Article 2 | スポーツ | トレーニング |
    | Article 3 | 案内広告 | トレーニング |
    | Article 4 | 案内広告 | トレーニング |
    | Article 5 | エンターテイメント | トレーニング |
    | Article 6 | エンターテイメント | トレーニング |
    | Article 7 | News | トレーニング |
    | Article 8 | News | トレーニング |
    | Article 9 | エンターテイメント | トレーニング |

    > **注** Language Studio ではファイルがアルファベット順に表示されるため、上記の一覧は順番に並んでいません。 記事にラベルを付けるときは、必ずドキュメントの両方のページにアクセスしてください。

1. **[ラベルの保存]** を選んでラベルを保存します。

## モデルをトレーニングする

データにラベルを付けた後、モデルをトレーニングする必要があります。

1. 左側のメニューで **[トレーニング ジョブ]** を選びます。
1. **[トレーニング ジョブの開始]** を選択します。
1. `ClassifyArticles` という名前の新しいモデルをトレーニングします。
1. **[トレーニングおよびテスト データの手動分割を使用する]** を選びます。

    > **ヒント** 独自の分類プロジェクトでは、Azure AI Language サービスは、テスト用セットを大規模なデータセットで有用なパーセンテージで自動的に分割します。 小規模なデータセットでは、適切なクラス分布でトレーニングすることが重要です。

1. [**トレーニング**] を選択します。

> **重要** モデルのトレーニングには、数分かかる場合があります。 完了すると、通知が表示されます。

## モデルを評価する

テキスト分類の実際のアプリケーションでは、モデルを評価して改善し、想定どおりに機能していることを確認することが重要です。

1. **[モデルのパフォーマンス]** を選んで、**ClassifyArticles** モデルを選びます。 モデルのスコア、パフォーマンス メトリクス、トレーニングされた日時を確認できます。 モデルのスコアリングが 100% ではない場合、テストに使われたドキュメントのいずれかが、ラベル付けされたとおりに評価されなかったことを意味します。 これらのエラーは、改善すべき点を理解するのに役立ちます。
1. **[テスト セットの詳細]** タブを選びます。エラーがある場合、このタブで、テスト対象として指定した記事と、モデルによってどのように予測されたか、それがテスト ラベルと矛盾するかどうかを確認できます。 既定値では、このタブには正しくない予測のみが表示されます。 **[不一致のみを表示する]** オプションを切り替えると、テスト対象として指定したすべての記事と、それぞれがどのように予測されたかを確認できます。

## モデルをデプロイする

モデルのトレーニングに問題がなければ、デプロイします。これにより、API を使用してテキストの分類を開始できます。

1. 左側のパネルで、**[Deploying model] (モデルのデプロイ)** を選びます。
1. **[デプロイの追加]** を選択し、**[新しいデプロイ名の作成]** フィールドに「`articles`」と入力し、**[モデル]** フィールドで **[ClassifyArticles]** を選択します。
1. **[デプロイ]** を選んでモデルをデプロイします。
1. モデルがデプロイされたら、そのページを開いたままにします。 次の手順で、このプロジェクトとデプロイの名前が必要になります。

## Cloud Shell でアプリを開発する準備をする

Azure AI Language サービスのカスタム テキスト分類機能をテストするには、Azure Cloud Shell で簡単なコンソール アプリケーションを開発します。

1. Azure portal で、ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal に新しい Cloud Shell を作成し、***PowerShell*** 環境を選択します。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。

    > **注**: *Bash* 環境を使用するクラウド シェルを以前に作成した場合は、それを ***PowerShell*** に切り替えます。

1. Cloud Shell ツール バーの **[設定]** メニューで、**[クラシック バージョンに移動]** を選択します (これはコード エディターを使用するのに必要です)。

    **<font color="red">続行する前に、クラシック バージョンの Cloud Shell に切り替えたことを確認します。</font>**

1. PowerShell ペインで、次のコマンドを入力して、この演習用の GitHub リポジトリを複製します。

    ```
   rm -r mslearn-ai-language -f
   git clone https://github.com/microsoftlearning/mslearn-ai-language
    ```

    > **ヒント**: Cloudshell にコマンドを貼り付けると、出力が大量のスクリーン バッファーを占有する可能性があります。 `cls` コマンドを入力して、各タスクに集中しやすくすることで、スクリーンをクリアできます。

1. リポジトリが複製されたら、アプリケーション コード ファイルを含むフォルダーに移動します。  

    ```
   cd mslearn-ai-language/Labfiles/04-text-classification/Python/classify-text
    ```

## アプリケーションを構成する

1. コマンド ラインで次のコマンドを実行して、**classify-text** フォルダー内のコード ファイルを表示します。

    ```
   ls -a -l
    ```

    これらのファイルとしては、構成ファイル (**.env**) とコード ファイル (**classify-text.py**) があります。 アプリケーションで分析するテキストは、**articles** サブフォルダー内にあります。

1. 次のコマンドを実行して、Python 仮想環境を作成し、Azure AI Language Text Analytics SDK パッケージとその他の必要なパッケージをインストールします。

    ```
   python -m venv labenv
   ./labenv/bin/Activate.ps1
   pip install -r requirements.txt azure-ai-textanalytics==5.3.0
    ```

1. 次のコマンドを入力して、アプリケーション構成ファイルを編集します。

    ```
   code .env
    ```

    このファイルをコード エディターで開きます。

1. 作成した Azure AI Language リソースの**エンドポイント**と**キー** (Azure portal の Azure AI Language リソースの **[キーとエンドポイント]** ページで入手可能) を含めるように構成値を更新します。ファイルには、テキスト分類モデルのプロジェクト名とデプロイ名が既に含まれています。
1. プレースホルダーを置き換えたら、コード エディター内で、**Ctrl + S** コマンドを使用するか、**右クリックして保存**で変更を保存してから、**Ctrl + Q** コマンドを使用するか、**右クリックして終了**で、Cloud Shell コマンド ラインを開いたままコード エディターを閉じます。

## ドキュメントを分類するコードを追加する

1. 次のコマンドを入力して、アプリケーション コード ファイルを編集します。

    ```
    code classify-text.py
    ```

1. 既存のコードを確認します。 AI Language Text Analytics SDK を操作するコードを追加します。

    > **ヒント**: コード ファイルにコードを追加する際は、必ず正しいインデントを維持してください。

1. コード ファイルの上部にある既存の名前空間参照の下で、**Import namespaces** というコメントを見つけて、Text Analytics SDK を使用するために必要な名前空間をインポートする次のコードを追加します。

    ```python
   # import namespaces
   from azure.core.credentials import AzureKeyCredential
   from azure.ai.textanalytics import TextAnalyticsClient
    ```

1. **main** 関数では、Azure AI Language サービスのエンドポイントとキー、およびプロジェクト名とデプロイ名を構成ファイルから読み込むコードが既に提供されていることに注意してください。 次に、**Create client using endpoint and key** というコメントを見つけて、テキスト分析クライアントを作成する次のコードを追加します。

    ```Python
   # Create client using endpoint and key
   credential = AzureKeyCredential(ai_key)
   ai_client = TextAnalyticsClient(endpoint=ai_endpoint, credential=credential)
    ```

1. 既存のコードは、**articles** フォルダー内のすべてのファイルを読み取り、その内容を含む一覧を作成することに注意してください。 次に、「**Get Classifications**」というコメントを見つけて、次のコードを追加します。

     ```Python
   # Get Classifications
   operation = ai_client.begin_single_label_classify(
        batchedDocuments,
        project_name=project_name,
        deployment_name=deployment_name
   )

   document_results = operation.result()

   for doc, classification_result in zip(files, document_results):
        if classification_result.kind == "CustomDocumentClassification":
            classification = classification_result.classifications[0]
            print("{} was classified as '{}' with confidence score {}.".format(
                doc, classification.category, classification.confidence_score)
            )
        elif classification_result.is_error is True:
            print("{} has an error with code '{}' and message '{}'".format(
                doc, classification_result.error.code, classification_result.error.message)
            )
    ```

1. 変更を保存し (Ctrl + S キー)、次のコマンドを入力してプログラムを実行します (コマンド ライン ペインにさらにテキストを表示するには、Cloud Shell ペインを最大化し、パネルをサイズ変更します)。

    ```
   python classify-text.py
    ```

1. 出力を確認します。 アプリケーションは、各テキスト ファイルの分類と信頼度スコアを一覧表示します。

## クリーンアップ

プロジェクトが必要なくなったら、Language Studio の **[プロジェクト]** ページから削除できます。 [Azure portal](https://portal.azure.com) でも、Azure AI Language サービスと関連付けられたストレージ アカウントを削除できます。
